<div class="min-h-screen bg-gray-900 text-white p-4 safe-area-top safe-area-bottom">
  <div class="max-w-2xl mx-auto">
    
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold mb-2">Session History</h1>
      <p class="text-gray-400">Track your brainwave training over time</p>
    </div>

    <!-- Recording Controls -->
    <div class="bg-gray-800 rounded-lg p-4 mb-6 border border-gray-700">
      @if (!isRecording()) {
        <button
          (click)="startRecording()"
          class="w-full touch-target px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <circle cx="10" cy="10" r="8"/>
          </svg>
          Start Recording Session
        </button>
      } @else {
        <div class="space-y-3">
          <div class="text-center">
            <div class="text-3xl font-bold text-green-400 mb-1">
              {{ formatDuration(currentDuration()) }}
            </div>
            <div class="text-sm text-gray-400">Recording in progress...</div>
          </div>
          <button
            (click)="stopRecording()"
            class="w-full touch-target px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <rect x="6" y="6" width="8" height="8"/>
            </svg>
            Stop Recording
          </button>
        </div>
      }
    </div>

    <!-- Summary Stats -->
    @if (summary().totalSessions > 0) {
      <div class="grid grid-cols-2 gap-3 mb-6">
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
          <div class="text-sm text-gray-400 mb-1">Total Sessions</div>
          <div class="text-2xl font-bold">{{ summary().totalSessions }}</div>
        </div>
        
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
          <div class="text-sm text-gray-400 mb-1">Total Time</div>
          <div class="text-2xl font-bold">{{ formatDuration(summary().totalTime) }}</div>
        </div>
        
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
          <div class="text-sm text-gray-400 mb-1">This Week</div>
          <div class="text-2xl font-bold">{{ formatDuration(summary().thisWeekTime) }}</div>
        </div>
        
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
          <div class="text-sm text-gray-400 mb-1">Favorite State</div>
          <div class="text-2xl font-bold capitalize">{{ summary().favoriteState }}</div>
        </div>
      </div>

      <!-- Export/Clear Actions -->
      <div class="flex gap-2 mb-6">
        <button
          (click)="exportSessions()"
          class="flex-1 touch-target px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors">
          Export Data
        </button>
        <button
          (click)="clearAllSessions()"
          class="flex-1 touch-target px-4 py-2 bg-red-900/30 hover:bg-red-900/50 border border-red-700 rounded-lg text-sm font-medium transition-colors">
          Clear All
        </button>
      </div>
    }

    <!-- Session List -->
    @if (sessions().length > 0) {
      <div class="space-y-3">
        <h2 class="text-lg font-semibold mb-3">Recent Sessions</h2>
        
        @for (session of sessions(); track session.id) {
          <div 
            (click)="viewSession(session)"
            class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-gray-600 cursor-pointer transition-colors">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm text-gray-400">{{ formatTime(session.startTime) }}</div>
              <div class="flex items-center gap-2">
                <div class="text-sm font-medium">{{ formatDuration(session.duration) }}</div>
                <button
                  (click)="deleteSession(session, $event)"
                  class="p-1 hover:bg-gray-700 rounded transition-colors">
                  <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- Dominant Band -->
            <div class="flex items-center gap-2 mb-2">
              <div 
                class="w-3 h-3 rounded-full"
                [style.background-color]="getBandColor(session.dominantBand)">
              </div>
              <div class="text-sm font-medium capitalize">
                Dominant: {{ session.dominantBand }}
              </div>
            </div>

            <!-- Mini Band Distribution -->
            <div class="flex gap-1 h-2 rounded-full overflow-hidden bg-gray-700">
              @for (item of getSortedBands(session); track item.band) {
                @if (item.stats.percentage > 0) {
                  <div 
                    [style.width.%]="item.stats.percentage"
                    [style.background-color]="getBandColor(item.band)"
                    [title]="item.band + ': ' + item.stats.percentage + '%'">
                  </div>
                }
              }
            </div>

            @if (session.notes) {
              <div class="mt-2 text-xs text-gray-400 italic truncate">
                "{{ session.notes }}"
              </div>
            }
          </div>
        }
      </div>
    } @else {
      <!-- Empty State -->
      <div class="text-center py-12 bg-gray-800 rounded-lg border border-gray-700">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        <h3 class="text-lg font-semibold mb-2">No Sessions Yet</h3>
        <p class="text-gray-400 mb-4">Start recording to track your brainwave patterns</p>
        <button
          (click)="startRecording()"
          class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition-colors">
          Start Your First Session
        </button>
      </div>
    }

    <!-- Footer: Version & Disclaimer -->
    <div class="mt-8 pt-6 border-t border-gray-700 space-y-3">
      <div class="text-center text-xs text-gray-500">
        <p class="font-medium">OpenBCI Brainwave Monitor v1.0.0</p>
      </div>
      
      <div class="text-center text-xs text-gray-500">
        <button 
          (click)="showDisclaimer = !showDisclaimer"
          class="cursor-pointer hover:text-gray-400 transition-colors inline-flex items-center gap-1"
          aria-expanded="{{showDisclaimer}}"
          aria-label="Toggle medical disclaimer">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Medical Disclaimer
          <svg class="w-3 h-3 transition-transform" [class.rotate-180]="showDisclaimer" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        
        @if (showDisclaimer) {
          <div class="mt-3 p-3 bg-gray-800/50 rounded text-left border border-yellow-600/30 max-w-xl mx-auto">
            <p class="mb-2">⚠️ <strong>For Research & Educational Use Only</strong></p>
            <p class="text-gray-400 leading-relaxed">
              This software is not a medical device and has not been evaluated by the FDA. 
              It is not intended to diagnose, treat, cure, or prevent any disease or medical condition. 
              Consult qualified healthcare professionals for medical advice. Use at your own risk.
            </p>
            <p class="mt-2 text-gray-500">
              Licensed under MIT License. See LICENSE file for details.
            </p>
          </div>
        }
      </div>
    </div>
  </div>
</div>

<!-- Session Details Modal -->
@if (selectedSession) {
  <div class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50" (click)="closeSessionDetails()">
    <div class="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="sticky top-0 bg-gray-800 border-b border-gray-700 p-4 flex items-center justify-between">
        <h2 class="text-xl font-bold">Session Details</h2>
        <button
          (click)="closeSessionDetails()"
          class="p-2 hover:bg-gray-700 rounded transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="p-4 space-y-4">
        <!-- Session Info -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="text-sm text-gray-400 mb-1">Started</div>
            <div class="font-medium">{{ formatTime(selectedSession.startTime) }}</div>
          </div>
          <div>
            <div class="text-sm text-gray-400 mb-1">Duration</div>
            <div class="font-medium">{{ formatDuration(selectedSession.duration) }}</div>
          </div>
        </div>

        <!-- Dominant Band -->
        <div class="bg-gray-900 rounded-lg p-4">
          <div class="text-sm text-gray-400 mb-2">Dominant State</div>
          <div class="flex items-center gap-3">
            <div 
              class="w-6 h-6 rounded-full"
              [style.background-color]="getBandColor(selectedSession.dominantBand)">
            </div>
            <div class="text-2xl font-bold capitalize">{{ selectedSession.dominantBand }}</div>
          </div>
        </div>

        <!-- Band Distribution -->
        <div>
          <h3 class="font-semibold mb-3">Time Distribution</h3>
          <div class="space-y-3">
            @for (item of getSortedBands(selectedSession); track item.band) {
              <div>
                <div class="flex items-center justify-between mb-1">
                  <div class="flex items-center gap-2">
                    <div 
                      class="w-3 h-3 rounded"
                      [style.background-color]="getBandColor(item.band)">
                    </div>
                    <span class="text-sm font-medium capitalize">{{ getBandInfo(item.band).label }}</span>
                    <span class="text-xs text-gray-500">{{ getBandInfo(item.band).range }}</span>
                  </div>
                  <div class="text-sm">
                    <span class="font-medium">{{ item.stats.percentage }}%</span>
                    <span class="text-gray-500 ml-1">({{ formatDuration(item.stats.totalTime) }})</span>
                  </div>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                  <div 
                    class="h-full transition-all duration-300"
                    [style.width.%]="item.stats.percentage"
                    [style.background-color]="getBandColor(item.band)">
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Notes Section -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Notes</h3>
            @if (!editingNotes) {
              <button
                (click)="toggleEditNotes()"
                class="text-sm text-blue-400 hover:text-blue-300">
                {{ selectedSession.notes ? 'Edit' : 'Add Notes' }}
              </button>
            }
          </div>
          
          @if (editingNotes) {
            <div class="space-y-2">
              <textarea
                [(ngModel)]="notesText"
                class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm resize-none"
                rows="4"
                placeholder="Add notes about this session..."></textarea>
              <div class="flex gap-2">
                <button
                  (click)="saveNotes()"
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors">
                  Save
                </button>
                <button
                  (click)="toggleEditNotes()"
                  class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors">
                  Cancel
                </button>
              </div>
            </div>
          } @else {
            @if (selectedSession.notes) {
              <div class="bg-gray-900 rounded-lg p-3 text-sm text-gray-300">
                {{ selectedSession.notes }}
              </div>
            } @else {
              <div class="text-sm text-gray-500 italic">No notes for this session</div>
            }
          }
        </div>
      </div>
    </div>
  </div>
}
